<!doctype html>
<html lang="sl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PDFme Editor (Railway)</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      /* TOPBAR = 1. vrstica: Name + akcije */
      #topbar { display: flex; gap: 8px; align-items: center; padding: 8px 12px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: #fff; z-index: 5; flex-wrap: wrap; }
      #nameWrap { display: flex; align-items: center; gap: 8px; }
      #tplName { min-width: 260px; }
      /* SUBBAR = 2. vrstica: Base PDFs v ENI vrstici */
      #subbar { display: flex; gap: 16px; align-items: center; padding: 8px 12px; border-bottom: 1px solid #e5e7eb; background: #fafafa; flex-wrap: wrap; }
      .baseGroup { display: flex; align-items: center; gap: 8px; }
      .label { font-size: 13px; color: #374151; min-width: 90px; }
      .badge { font-size: 12px; padding: 2px 6px; background: #eef2ff; border: 1px solid #c7d2fe; border-radius: 999px; }
      .warn  { background: #fff7ed; border-color: #fed7aa; }
      .good  { background: #ecfdf5; border-color: #bbf7d0; }
      .filehint { font-size: 12px; color: #6b7280; }
      .spacer { flex: 1; }
      .muted { color: #6b7280; font-size: 12px; }
      #container { height: calc(100% - 116px); }
      button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; cursor: pointer; }
      input, select { padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; }
      #err { display:none; padding:10px 12px; color:#991b1b; background:#fef2f2; border:1px solid #fecaca; }
    </style>
  </head>
  <body>
    <div id="err"></div>

    <!-- TOP vrstica -->
    <div id="topbar">
      <strong>PDFme Editor</strong>

      <div id="nameWrap">
        <span class="label">Name:</span>
        <input id="tplName" placeholder="Template name" />
      </div>

      <button id="btnNew">New</button>
      <button id="btnSave">Save</button>
      <button id="btnSaveAs">Save As</button>
      <button id="btnDelete" style="background:#fff5f5;border-color:#f5c2c2">Delete</button>
      <button id="btnPreview">Preview</button>

      <span class="spacer"></span>

      <select id="tplList" style="min-width:320px"></select>
      <button id="btnLoad">Load</button>

      <button id="btnSetToken">Set Token</button>
      <button id="btnLogout" style="display:none">Logout</button>

      <div class="muted">Current ID: <span id="currentId">(none)</span></div>
    </div>

    <!-- Druga vrstica -->
    <div id="subbar">
      <div class="baseGroup">
        <span class="label">Page 1 base:</span>
        <input type="file" id="base1File" accept="application/pdf" />
        <button id="btnBase1Upload">Upload</button>
        <button id="btnBase1Clear">Clear</button>
        <button id="btnBase1Download">Download</button>
        <span id="base1Status" class="badge warn">not set</span>
      </div>

      <div class="baseGroup">
        <span class="label">Page 2+ base:</span>
        <input type="file" id="base2File" accept="application/pdf" />
        <button id="btnBase2Upload">Upload</button>
        <button id="btnBase2Clear">Clear</button>
        <button id="btnBase2Download">Download</button>
        <span id="base2Status" class="badge warn">not set</span>
      </div>

      <div class="filehint">Če dokument preseže 1 stran, se na vseh naslednjih straneh uporabi Page&nbsp;2+ base.</div>
    </div>

    <div id="container"></div>

    <script type="module">
      // -------- robusten import (bundlano) --------
      const uiMod     = await import('https://esm.sh/@pdfme/ui@5?target=es2020&bundle');
      const commonMod = await import('https://esm.sh/@pdfme/common@5?target=es2020&bundle');
      // @pdfme/schemas kot bundlan namespace (včasih je težava, če ni bundlano)
      const schMod    = await import('https://esm.sh/@pdfme/schemas@5?target=es2020&bundle');

      const { Designer } = uiMod;
      const { BLANK_PDF } = commonMod;

      // Vsi plugin-i
      const plugins = {
        text: schMod.text,
        image: schMod.image,
        rect: schMod.rect,
        line: schMod.line,
        table: schMod.table,
        barcode: schMod.barcode, // qrcode, code128, ean13, ...
      };

      // --- mini helper za prikaz napak ---
      function showErr(e) {
        const box = document.getElementById('err');
        box.style.display = 'block';
        box.textContent = 'Error: ' + (e?.message || e);
        console.error(e);
      }

      try {
        // --- API config & auth ---
        const API = { base: location.origin, token: localStorage.getItem('EDITOR_TOKEN') || '' };
        function headers() {
          return API.token
            ? { 'Authorization': `Bearer ${API.token}`, 'Content-Type': 'application/json' }
            : { 'Content-Type': 'application/json' };
        }
        function updateAuthButtons() {
          const has = !!API.token;
          document.getElementById('btnSetToken').style.display = has ? 'none' : 'inline-block';
          document.getElementById('btnLogout').style.display = has ? 'inline-block' : 'none';
        }
        document.getElementById('btnSetToken').onclick = async () => {
          const t = prompt('Paste EDITOR_AUTH_TOKEN');
          if (t && t.trim()) {
            API.token = t.trim();
            localStorage.setItem('EDITOR_TOKEN', API.token);
            updateAuthButtons();
            await refreshList();
            alert('Token set.');
          }
        };
        document.getElementById('btnLogout').onclick = async () => {
          localStorage.removeItem('EDITOR_TOKEN');
          API.token = '';
          updateAuthButtons();
          await refreshList();
          alert('Logged out.');
        };

        // --- State ---
        let currentId = null;
        let secondBasePdf = null; // dataURL ali null
        function setCurrentId(id) {
          currentId = id || null;
          document.getElementById('currentId').textContent = currentId || '(none)';
          const sel = document.getElementById('tplList');
          if (currentId) {
            const opt = [...sel.options].find(o => o.value === currentId);
            if (opt) sel.value = currentId;
          }
        }

        // --- Initial template ---
        const initialTemplate = {
          basePdf: BLANK_PDF,
          schemas: [[
            { name: 'title', type: 'text', position: { x: 20, y: 20 }, width: 170, height: 15 }
          ]]
        };

        // --- Base PDF utils ---
        async function fileToDataUrl(file) {
          const buf = await file.arrayBuffer();
          const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
          return `data:application/pdf;base64,${b64}`;
        }
        function downloadDataUrlAs(name, dataUrl) {
          const a = document.createElement('a');
          a.href = dataUrl; a.download = name || 'base.pdf';
          document.body.appendChild(a); a.click(); a.remove();
        }
        function setBaseStatus(which, has) {
          const el = document.getElementById(which === 1 ? 'base1Status' : 'base2Status');
          el.textContent = has ? 'set' : 'not set';
          el.className = 'badge ' + (has ? 'good' : 'warn');
        }

        // --- Mount Designer (z vsemi plugini) ---
        const container = document.getElementById('container');
        const designer = new Designer({
          domContainer: container,
          template: initialTemplate,
          plugins,
          options: { zoomLevel: 1 }
        });

        // --- Template list ---
        async function refreshList() {
          try {
            const res = await fetch(`${API.base}/api/templates`, { headers: headers() });
            if (!res.ok) {
              console.warn('Template list failed', res.status);
              document.getElementById('tplList').innerHTML = '';
              return;
            }
            const list = await res.json();
            const select = document.getElementById('tplList');
            select.innerHTML = '';
            for (const r of list) {
              const opt = document.createElement('option');
              opt.value = r.id; opt.textContent = `${r.name} — ${r.id}`;
              select.appendChild(opt);
            }
            if (currentId) {
              const opt = [...select.options].find(o => o.value === currentId);
              if (opt) sel.value = currentId;
            }
          } catch (e) { showErr(e); }
        }

        // --- CRUD helpers ---
        async function createTemplate() {
          const name = document.getElementById('tplName').value || 'Untitled Template';
          const template = designer.getTemplate();
          if (secondBasePdf) template._secondBasePdf = secondBasePdf; else delete template._secondBasePdf;
          const res = await fetch(`${API.base}/api/templates`, {
            method: 'POST', headers: headers(), body: JSON.stringify({ name, template })
          });
          if (!res.ok) throw new Error('Create failed');
          const obj = await res.json();
          setCurrentId(obj.id);
          return obj;
        }

        async function updateTemplate(id) {
          const name = document.getElementById('tplName').value || 'Untitled Template';
          const template = designer.getTemplate();
          if (secondBasePdf) template._secondBasePdf = secondBasePdf; else delete template._secondBasePdf;
          const res = await fetch(`${API.base}/api/templates/${id}`, {
            method: 'PUT', headers: headers(), body: JSON.stringify({ name, template })
          });
          if (!res.ok) throw new Error('Update failed');
          const obj = await res.json();
          setCurrentId(obj.id);
          return obj;
        }

        async function deleteTemplate(id) {
          const res = await fetch(`${API.base}/api/templates/${id}`, { method: 'DELETE', headers: headers() });
          if (res.status === 204) return true;
          if (res.status === 404) throw new Error('Template not found');
          throw new Error('Delete failed');
        }

        // --- Topbar handlers ---
        document.getElementById('btnNew').onclick = () => {
          designer.updateTemplate(initialTemplate);
          document.getElementById('tplName').value = '';
          secondBasePdf = null;
          setBaseStatus(1, false);
          setBaseStatus(2, false);
          setCurrentId(null);
        };

        document.getElementById('btnSave').onclick = async () => {
          try {
            if (currentId) await updateTemplate(currentId); else await createTemplate();
            await refreshList();
            alert('Saved!');
          } catch (e) { showErr(e); alert(e.message || 'Save failed'); }
        };

        document.getElementById('btnSaveAs').onclick = async () => {
          try {
            setCurrentId(null);
            await createTemplate();
            await refreshList();
            alert('Saved as new template!');
          } catch (e) { showErr(e); alert(e.message || 'Save As failed'); }
        };

        document.getElementById('btnLoad').onclick = async () => {
          const id = document.getElementById('tplList').value; if (!id) return;
          const res = await fetch(`${API.base}/api/templates/${id}`, { headers: headers() });
          if (!res.ok) return alert('Load failed');
          const { name, template, id: loadedId } = await res.json();
          document.getElementById('tplName').value = name;
          designer.updateTemplate(template);
          secondBasePdf = typeof template._secondBasePdf === 'string' ? template._secondBasePdf : null;
          setBaseStatus(1, typeof template.basePdf === 'string');
          setBaseStatus(2, !!secondBasePdf);
          setCurrentId(loadedId || id);
        };

        document.getElementById('btnDelete').onclick = async () => {
          try {
            if (!currentId) return alert('Ni izbranega template-a (Current ID je prazen).');
            const currentName = document.getElementById('tplName').value || '(unnamed)';
            const sure = confirm(`Res želiš izbrisati template?\n\nName: ${currentName}\nID: ${currentId}`);
            if (!sure) return;
            await deleteTemplate(currentId);
            setCurrentId(null);
            document.getElementById('tplName').value = '';
            designer.updateTemplate(initialTemplate);
            secondBasePdf = null;
            setBaseStatus(1, false);
            setBaseStatus(2, false);
            await refreshList();
            alert('Deleted.');
          } catch (e) { showErr(e); alert(e.message || 'Delete failed'); }
        };

        document.getElementById('btnPreview').onclick = async () => {
          try {
            const t = designer.getTemplate();
            if (secondBasePdf) t._secondBasePdf = secondBasePdf; else delete t._secondBasePdf;
            const inputs = [ { title: 'Hello from PDFme' }, { title: 'Second page' } ];
            const res = await fetch(`${API.base}/api/render`, {
              method: 'POST', headers: headers(), body: JSON.stringify({ template: t, inputs, fileName: 'preview' })
            });
            if (!res.ok) return alert('Preview failed');
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
          } catch (e) { showErr(e); alert('Preview error'); }
        };

        // --- Base PDF buttons ---
        document.getElementById('btnBase1Upload').onclick = async () => {
          const f = document.getElementById('base1File').files?.[0];
          if (!f) return alert('Izberi PDF datoteko.');
          const dataUrl = await fileToDataUrl(f);
          const tpl = designer.getTemplate();
          tpl.basePdf = dataUrl;
          designer.updateTemplate(tpl);
          setBaseStatus(1, true);
          alert('Base PDF (page 1) set.');
        };
        document.getElementById('btnBase1Clear').onclick = () => {
          const tpl = designer.getTemplate();
          tpl.basePdf = BLANK_PDF;
          designer.updateTemplate(tpl);
          setBaseStatus(1, false);
        };
        document.getElementById('btnBase1Download').onclick = () => {
          const tpl = designer.getTemplate();
          if (typeof tpl.basePdf === 'string') {
            const name = (document.getElementById('tplName').value || 'template') + '_base_page1.pdf';
            downloadDataUrlAs(name, tpl.basePdf);
          } else {
            alert('Ni nastavljenega Base PDF (page 1).');
          }
        };

        document.getElementById('btnBase2Upload').onclick = async () => {
          const f = document.getElementById('base2File').files?.[0];
          if (!f) return alert('Izberi PDF datoteko.');
          secondBasePdf = await fileToDataUrl(f);
          setBaseStatus(2, true);
          alert('Second-page Base PDF set.');
        };
        document.getElementById('btnBase2Clear').onclick = () => {
          secondBasePdf = null;
          setBaseStatus(2, false);
        };
        document.getElementById('btnBase2Download').onclick = () => {
          if (secondBasePdf) {
            const name = (document.getElementById('tplName').value || 'template') + '_base_page2plus.pdf';
            downloadDataUrlAs(name, secondBasePdf);
          } else {
            alert('Ni nastavljenega Second-page Base PDF.');
          }
        };

        // Init
        updateAuthButtons();
        setCurrentId(null);
        setBaseStatus(1, false);
        setBaseStatus(2, false);
        document.getElementById('tplName').value = '';
        refreshList();
      } catch (e) {
        showErr(e);
      }
    </script>
  </body>
</html>